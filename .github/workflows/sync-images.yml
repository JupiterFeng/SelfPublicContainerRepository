name: Sync Container Images to GHCR

on:
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  sync-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Sync images to GHCR
        run: |
          # ËØªÂèñÈïúÂÉèÂàóË°®Êñá‰ª∂
          IMAGES_FILE="images.txt"
          
          if [ ! -f "$IMAGES_FILE" ]; then
            echo "‚ùå ÈïúÂÉèÂàóË°®Êñá‰ª∂ $IMAGES_FILE ‰∏çÂ≠òÂú®"
            exit 1
          fi
          
          echo "üìã ÂºÄÂßãÂêåÊ≠•ÈïúÂÉè..."
          echo "========================================"
          
          # ÁªüËÆ°‰ø°ÊÅØ
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          SKIP_COUNT=0
          
          # ÈÄêË°åËØªÂèñÈïúÂÉèÂàóË°®
          while IFS= read -r line || [ -n "$line" ]; do
            # Ë∑≥ËøáÁ©∫Ë°åÂíåÊ≥®Èáä
            line=$(echo "$line" | xargs)
            if [ -z "$line" ] || [[ "$line" == \#* ]]; then
              continue
            fi
            
            SOURCE_IMAGE="$line"
            
            # Ëß£ÊûêÈïúÂÉèÂêçÂíåÊ†áÁ≠æ
            if [[ "$SOURCE_IMAGE" == *":"* ]]; then
              IMAGE_NAME="${SOURCE_IMAGE%:*}"
              IMAGE_TAG="${SOURCE_IMAGE##*:}"
            else
              IMAGE_NAME="$SOURCE_IMAGE"
              IMAGE_TAG="latest"
            fi
            
            # Â§ÑÁêÜÂåÖÂê´ / ÁöÑÈïúÂÉèÂêçÔºàÂ¶Ç library/nginx Êàñ bitnami/redisÔºâ
            # Â∞Ü / ÊõøÊç¢‰∏∫ - ‰ª•Á¨¶Âêà GHCR ÂëΩÂêçËßÑËåÉ
            SAFE_IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '/' '-')
            
            # Â∞Ü‰ªìÂ∫ìÊâÄÊúâËÄÖËΩ¨Êç¢‰∏∫Â∞èÂÜôÔºàGHCR Ë¶ÅÊ±ÇÂøÖÈ°ªÂ∞èÂÜôÔºâ
            OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            
            # ÁõÆÊ†áÈïúÂÉèÂú∞ÂùÄ
            TARGET_IMAGE="${{ env.REGISTRY }}/${OWNER_LOWER}/${SAFE_IMAGE_NAME}:${IMAGE_TAG}"
            
            echo ""
            echo "üîÑ Ê≠£Âú®ÂêåÊ≠•: $SOURCE_IMAGE"
            echo "   ÁõÆÊ†áÂú∞ÂùÄ: $TARGET_IMAGE"
            
            # ÊãâÂèñÊ∫êÈïúÂÉè
            if docker pull "$SOURCE_IMAGE"; then
              echo "   ‚úÖ ÊãâÂèñÊàêÂäü"
              
              # ÈáçÊñ∞Ê†áËÆ∞ÈïúÂÉè
              docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
              
              # Êé®ÈÄÅÂà∞ GHCR
              if docker push "$TARGET_IMAGE"; then
                echo "   ‚úÖ Êé®ÈÄÅÊàêÂäü: $TARGET_IMAGE"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "   ‚ùå Êé®ÈÄÅÂ§±Ë¥•: $TARGET_IMAGE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
              
              # Ê∏ÖÁêÜÊú¨Âú∞ÈïúÂÉè‰ª•ËäÇÁúÅÁ©∫Èó¥
              docker rmi "$SOURCE_IMAGE" "$TARGET_IMAGE" 2>/dev/null || true
            else
              echo "   ‚ùå ÊãâÂèñÂ§±Ë¥•: $SOURCE_IMAGE"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
            
          done < "$IMAGES_FILE"
          
          echo ""
          echo "========================================"
          echo "üìä ÂêåÊ≠•ÂÆåÊàêÁªüËÆ°:"
          echo "   ‚úÖ ÊàêÂäü: $SUCCESS_COUNT"
          echo "   ‚ùå Â§±Ë¥•: $FAIL_COUNT"
          echo "========================================"
          
          # Â¶ÇÊûúÊúâÂ§±Ë¥•ÁöÑÈïúÂÉèÔºåËøîÂõûÈùûÈõ∂ÈÄÄÂá∫Á†Å
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è ÈÉ®ÂàÜÈïúÂÉèÂêåÊ≠•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êó•Âøó"
            exit 1
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "## ÈïúÂÉèÂêåÊ≠•Êä•Âëä üì¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‰ªìÂ∫ì:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ËøêË°åÊó∂Èó¥:** \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ÂêåÊ≠•ÁöÑÈïúÂÉèÂàóË°®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ê∫êÈïúÂÉè | ÁõÆÊ†áÂú∞ÂùÄ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | xargs)
            if [ -z "$line" ] || [[ "$line" == \#* ]]; then
              continue
            fi
            
            SOURCE_IMAGE="$line"
            if [[ "$SOURCE_IMAGE" == *":"* ]]; then
              IMAGE_NAME="${SOURCE_IMAGE%:*}"
              IMAGE_TAG="${SOURCE_IMAGE##*:}"
            else
              IMAGE_NAME="$SOURCE_IMAGE"
              IMAGE_TAG="latest"
            fi
            
            SAFE_IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '/' '-')
            OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            TARGET_IMAGE="${{ env.REGISTRY }}/${OWNER_LOWER}/${SAFE_IMAGE_NAME}:${IMAGE_TAG}"
            
            echo "| \`$SOURCE_IMAGE\` | \`$TARGET_IMAGE\` |" >> $GITHUB_STEP_SUMMARY
          done < "images.txt"
